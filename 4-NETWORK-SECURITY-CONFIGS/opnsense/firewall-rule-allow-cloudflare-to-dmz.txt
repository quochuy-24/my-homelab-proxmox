# =================================================================
# OPNsense Core Firewall Ruleset for a Multi-Layered Network
# =================================================================

This document outlines the key firewall rules implemented to enforce the network segmentation policy between LAN, DMZ, and WAN zones. The philosophy is "Deny by Default," only allowing explicitly defined traffic.

---

### **1. LAN Interface Rules (Secure Internal Zone)**
*The default "Allow to Any" rule was removed to enforce granular control.*

- **Rule: Allow LAN to OPNsense DNS**
  - Action: Pass
  - Interface: LAN
  - Source: LAN net
  - Destination: LAN address
  - Protocol: UDP/53
  - Description: Critical for internal clients to resolve domain names.

- **Rule: Allow LAN to Internet (Web Traffic)**
  - Action: Pass
  - Interface: LAN
  - Source: LAN net
  - Destination: any
  - Protocol: TCP/80 (HTTP), TCP/443 (HTTPS)
  - Description: Allows internal clients to browse the web.

- **Rule: Allow LAN to Internet (Ping)**
  - Action: Pass
  - Interface: LAN
  - Source: LAN net
  - Destination: any
  - Protocol: ICMP
  - Description: Allows internal clients to use the ping utility for network troubleshooting.

- **Rule: Allow Cloudflare Tunnel to DMZ (CRITICAL FOR PUBLIC ACCESS)**
  - Action: Pass
  - Interface: LAN
  - Source: IP of `cloudflare-tunnel` container (e.g., 10.10.10.2)
  - Destination: IP of Web Server / K8s Node in DMZ (e.g., 10.10.20.10)
  - Protocol: TCP/80, TCP/443
  - Description: Enables the successful Cloudflare Tunnel solution by allowing it to forward traffic to the DMZ.

---

### **2. DMZ Interface Rules (Semi-Trusted Zone)**

- **Rule: BLOCK DMZ to LAN (MOST IMPORTANT SECURITY RULE)**
  - Action: Block
  - Interface: DMZ
  - Source: DMZ net
  - Destination: LAN net
  - Protocol: any
  - Description: Prevents a compromised public-facing server in the DMZ from attacking the secure internal LAN. This rule is placed at the top of the list for priority.

- **Rule: Allow DMZ to Internet**
  - Action: Pass
  - Interface: DMZ
  - Source: DMZ net
  - Destination: any
  - Protocol: any
  - Description: Allows servers in the DMZ to reach out to the internet for updates, API calls, etc.

---

### **3. WAN Interface Rules (Untrusted Zone)**

- **Default Policy:** All unsolicited inbound traffic is blocked by default (Stateful Firewall).
- **Explicit Rules:**
  - Rules are only created to allow specific inbound traffic, such as:
    - The rule automatically generated by the (failed) Port Forwarding attempt.
    - A rule to allow the `bastion-host` (e.g., 192.168.1.102) to access services in the DMZ for management purposes.